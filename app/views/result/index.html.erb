<% content_for :app_title do %>
    <%= "Search Performance Explorer" %>
<% end %>

<div class="wrapper">

  <div class="head-section">

    <div class="heading">

      <% if params["search_term"].blank? %>
        <h1 class="head-text">You did not enter a search term</h1>
      <% else %>
        <h1 class="head-text">You searched for</h1>
        <h2 class="search-term"><%= params["search_term"] %></h2>
      <% end %>

      <h2 class="results-text">These are your results</h2>

    </div>

    <div class="new-search">

      <h2 class="head-text">New Search</h2>

      <form id="homepage-form" action="/result" method="get">

        <div class="form-group">
          <label class="form-label" for="search_term_input">
            Search term to compare
          </label>
          <%= text_field_tag("search_term", "", class: "form-control") %>
        </div>

        <div class="form-group">
          <label class="form-label" for="result_count">
            Required number of results
          </label>
          <%= number_field_tag("count", "#{params["count"]}", class: "form-control", id: "result_count") %>
        </div>

        <input type="hidden" name="which_test" value="<%= params["which_test"] %>"/>

        <input class="button" id="search_button" type="submit" value="Search"></input>

      </form>

    </div>
  </div>

  <div class="grid-row">



    <%# Sets the base bit of the url and adds the user
        defined search term connected with '+' so it's in
        the right format                                  %>
    <%  url = 'https://www.gov.uk/api/search.json?q='
        term = params["search_term"]
        url += term.split.join("+")   %>

    <%# Allows the user to not enter a result count (default's 10)
        and caps the displayed results at 1000 as per API limit.
        Also adds the count to the URL that's passed in        %>
    <% if params["count"].blank? %>
      <% count = "10" %>
    <% elsif params["count"].to_i > 1000 %>
      <% count = "1000" %>
    <% else %>
      <%count = params["count"] %>
    <% end %>
    <% url += "&count=" + count %>


    <%# Creates an empty hash to put the search results from our 'A'
        test in, also an array to add our 'A' titles and a counter
        to increment within each of the following loops
                                  %>
    <% a_list = {} %>
    <% a_list_titles = [] %>
    <% a_counter = 0 %>
    <% b_counter = 0 %>

    <%# <h2 class="results-header">A Results</h2> %>
    <%# Adds the A test parameter to the URL  %>
    <% uri = URI("#{url}&ab_tests=#{params["which_test"]}:A") %>
    <%# Gets a result from the search API based on the URL we made %>
    <% response = Net::HTTP.get(uri) %>
    <% findings_left = JSON.parse(response) %>
    <%# Loops over the 'results' section of our result %>
    <% findings_left["results"].each do |each_bit| %>
      <%# increments counter and creates hash entry based on link and counter %>
      <% a_counter += 1 %>
      <% a_list["#{each_bit["link"]}"] = a_counter %>
      <% a_list_titles << each_bit["title"] %>
    <% end %>
    <% uri = URI("#{url}&ab_tests=#{params["which_test"]}:B") %>
    <% response = Net::HTTP.get(uri) %>
    <% findings_right = JSON.parse(response) %>

    <table class="results-table" >
      <tr class="table-row" class="table-row">
        <th scope="col"><h3 class="heading-27" >A Results</h3></th>
        <th scope="col"><h3 class="heading-27" >B Results</h3></th>
        <th scope="col"><h3 class="heading-27" >Difference</h3></th>
      </tr>
      <% b_counter = 0 %>
      <% findings_right["results"].each do |each_bit| %>
        <tr class="table-row">
          <% if a_list["#{each_bit["link"]}"] %>
            <% score_difference = a_list["#{each_bit["link"]}"] - b_counter - 1 %>
          <% else %>
            <% score_difference = "++++"  %>
          <% end %>

          <% if a_list.key(b_counter + 1) %>
            <% a_link = "https://gov.uk" + a_list.key(b_counter + 1) %>
          <% end %>

          <th>
            <a href= "<%= a_link %>" >
              <p class="table-body">
                <% if a_list_titles[b_counter] %>
                  <%= truncate(a_list_titles[b_counter], :length => 50 ) %>
                <% else %>
                  <%= "" %>
                <% end %>
              </p>
            </a>
          </th>

          <% link = "https://gov.uk" + each_bit["link"] %>
          <th>
            <a href = "<%= link %>" >
              <p class="table-body">
                <%= truncate(each_bit["title"], :length => 50 ) %>
              </p>
            </a>
          </th>

          <% if score_difference == "++++"%>
            <th>
              <div class="up-box">
                <p class="table-body">
                  <%= score_difference %>
                </p>
              </div>
            </th>
          <% elsif score_difference == 0 %>
            <th>
              <div class="changeless-box">
                <p class="table-body">
                  N/A
                </p>
              </div>
            </th>
          <% elsif score_difference > 0 %>
            <th>
              <div class="up-box">
                <p class="table-body">
                  <%= "+#{score_difference}" %>
                </p>
              </div>
            </th>
          <% else %>
            <th>
              <div class="down-box">
                <p class="table-body">
                  <%= score_difference %>
                </p>
              </div>
            </th>
          <% end %>
          <% b_counter += 1 %>
        </tr>
      <% end %>
      <tr class="table-row">
        <th>
          <% number = findings_left["total"] - count.to_i %>
          <% number = 0 if number < 0 %>
          <%= findings_left["total"] %> results, <%= number %> not shown
        </th>
        <th>
          <% number = findings_right["total"] - count.to_i %>
          <% number = 0 if number < 0 %>
          <p class="table-body">
            <%= "#{findings_right["total"]} results, #{number} not shown" %>
          </p>
        </th>
        <th>
        </th>
      </tr>
    </table>
  </div>
</div>
